<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Elasticsearch 聚合 | DB-TUTORIAL</title>
    <meta name="generator" content="VuePress 1.9.2">
    <link rel="icon" href="/db-tutorial/img/favicon.ico">
    <meta name="description" content="☕ db-tutorial 是一个数据库教程。">
    <meta name="keywords" content="vuepress,theme,blog,vdoing">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/db-tutorial/assets/css/0.styles.0fa5ab37.css" as="style"><link rel="preload" href="/db-tutorial/assets/js/app.8ee26433.js" as="script"><link rel="preload" href="/db-tutorial/assets/js/2.f928080b.js" as="script"><link rel="preload" href="/db-tutorial/assets/js/61.ccb61a01.js" as="script"><link rel="prefetch" href="/db-tutorial/assets/js/10.4b8e20fa.js"><link rel="prefetch" href="/db-tutorial/assets/js/11.b91609e5.js"><link rel="prefetch" href="/db-tutorial/assets/js/12.dc9d3b84.js"><link rel="prefetch" href="/db-tutorial/assets/js/13.779543c7.js"><link rel="prefetch" href="/db-tutorial/assets/js/14.00604466.js"><link rel="prefetch" href="/db-tutorial/assets/js/15.3491ddad.js"><link rel="prefetch" href="/db-tutorial/assets/js/16.111fc8a7.js"><link rel="prefetch" href="/db-tutorial/assets/js/17.abc2ccd5.js"><link rel="prefetch" href="/db-tutorial/assets/js/18.b6bac511.js"><link rel="prefetch" href="/db-tutorial/assets/js/19.99cf3702.js"><link rel="prefetch" href="/db-tutorial/assets/js/20.01909da2.js"><link rel="prefetch" href="/db-tutorial/assets/js/21.480661a0.js"><link rel="prefetch" href="/db-tutorial/assets/js/22.21510631.js"><link rel="prefetch" href="/db-tutorial/assets/js/23.c8923f93.js"><link rel="prefetch" href="/db-tutorial/assets/js/24.3c05a178.js"><link rel="prefetch" href="/db-tutorial/assets/js/25.bbd89732.js"><link rel="prefetch" href="/db-tutorial/assets/js/26.586443bf.js"><link rel="prefetch" href="/db-tutorial/assets/js/27.a049ae57.js"><link rel="prefetch" href="/db-tutorial/assets/js/28.4a9575a5.js"><link rel="prefetch" href="/db-tutorial/assets/js/29.0fe52a42.js"><link rel="prefetch" href="/db-tutorial/assets/js/3.4fef494d.js"><link rel="prefetch" href="/db-tutorial/assets/js/30.d7cd3e96.js"><link rel="prefetch" href="/db-tutorial/assets/js/31.b55fd90f.js"><link rel="prefetch" href="/db-tutorial/assets/js/32.4d707168.js"><link rel="prefetch" href="/db-tutorial/assets/js/33.6ed7befa.js"><link rel="prefetch" href="/db-tutorial/assets/js/34.099e1a01.js"><link rel="prefetch" href="/db-tutorial/assets/js/35.27a66a7f.js"><link rel="prefetch" href="/db-tutorial/assets/js/36.f584024d.js"><link rel="prefetch" href="/db-tutorial/assets/js/37.d4eb2509.js"><link rel="prefetch" href="/db-tutorial/assets/js/38.86f31e48.js"><link rel="prefetch" href="/db-tutorial/assets/js/39.168d9cb3.js"><link rel="prefetch" href="/db-tutorial/assets/js/4.a1a948d8.js"><link rel="prefetch" href="/db-tutorial/assets/js/40.ce6bd3c2.js"><link rel="prefetch" href="/db-tutorial/assets/js/41.ee425fb7.js"><link rel="prefetch" href="/db-tutorial/assets/js/42.1cd7d290.js"><link rel="prefetch" href="/db-tutorial/assets/js/43.ce51f231.js"><link rel="prefetch" href="/db-tutorial/assets/js/44.ca9061e0.js"><link rel="prefetch" href="/db-tutorial/assets/js/45.b804cc2e.js"><link rel="prefetch" href="/db-tutorial/assets/js/46.f36446ba.js"><link rel="prefetch" href="/db-tutorial/assets/js/47.4a7c5fae.js"><link rel="prefetch" href="/db-tutorial/assets/js/48.fae5bf7e.js"><link rel="prefetch" href="/db-tutorial/assets/js/49.30242ef4.js"><link rel="prefetch" href="/db-tutorial/assets/js/5.a6954c0a.js"><link rel="prefetch" href="/db-tutorial/assets/js/50.b81f3cfc.js"><link rel="prefetch" href="/db-tutorial/assets/js/51.05cc7803.js"><link rel="prefetch" href="/db-tutorial/assets/js/52.a40f9c26.js"><link rel="prefetch" href="/db-tutorial/assets/js/53.b7405c51.js"><link rel="prefetch" href="/db-tutorial/assets/js/54.dfdb2bc0.js"><link rel="prefetch" href="/db-tutorial/assets/js/55.f72c4cd1.js"><link rel="prefetch" href="/db-tutorial/assets/js/56.58ec37d1.js"><link rel="prefetch" href="/db-tutorial/assets/js/57.77795441.js"><link rel="prefetch" href="/db-tutorial/assets/js/58.48774179.js"><link rel="prefetch" href="/db-tutorial/assets/js/59.3e3a8d46.js"><link rel="prefetch" href="/db-tutorial/assets/js/6.a908186a.js"><link rel="prefetch" href="/db-tutorial/assets/js/60.5d9b56f7.js"><link rel="prefetch" href="/db-tutorial/assets/js/62.4f8df7e3.js"><link rel="prefetch" href="/db-tutorial/assets/js/63.e8282ea6.js"><link rel="prefetch" href="/db-tutorial/assets/js/64.8630da18.js"><link rel="prefetch" href="/db-tutorial/assets/js/65.f5ca623c.js"><link rel="prefetch" href="/db-tutorial/assets/js/66.1117c91b.js"><link rel="prefetch" href="/db-tutorial/assets/js/67.3bdba886.js"><link rel="prefetch" href="/db-tutorial/assets/js/68.d38a4ff6.js"><link rel="prefetch" href="/db-tutorial/assets/js/69.6305d19e.js"><link rel="prefetch" href="/db-tutorial/assets/js/7.c53d9cb5.js"><link rel="prefetch" href="/db-tutorial/assets/js/70.73da32af.js"><link rel="prefetch" href="/db-tutorial/assets/js/71.4d17170e.js"><link rel="prefetch" href="/db-tutorial/assets/js/72.22732a6e.js"><link rel="prefetch" href="/db-tutorial/assets/js/73.17368c1b.js"><link rel="prefetch" href="/db-tutorial/assets/js/74.ba97d966.js"><link rel="prefetch" href="/db-tutorial/assets/js/75.e6aa4b3f.js"><link rel="prefetch" href="/db-tutorial/assets/js/76.c3c25530.js"><link rel="prefetch" href="/db-tutorial/assets/js/77.16dd6f20.js"><link rel="prefetch" href="/db-tutorial/assets/js/78.50b57aa1.js"><link rel="prefetch" href="/db-tutorial/assets/js/79.8382aa5b.js"><link rel="prefetch" href="/db-tutorial/assets/js/8.b46edd8a.js"><link rel="prefetch" href="/db-tutorial/assets/js/9.36ee61bb.js">
    <link rel="stylesheet" href="/db-tutorial/assets/css/0.styles.0fa5ab37.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/db-tutorial/" class="home-link router-link-active"><img src="https://raw.githubusercontent.com/dunwu/images/dev/common/dunwu-logo-200.png" alt="DB-TUTORIAL" class="logo"> <span class="site-name can-hide">DB-TUTORIAL</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/db-tutorial/01.数据库综合/" class="nav-link">数据库综合</a></div><div class="nav-item"><a href="/db-tutorial/02.数据库中间件/" class="nav-link">数据库中间件</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关系型数据库" class="dropdown-title"><a href="/db-tutorial/03.关系型数据库/" class="link-title">关系型数据库</a> <span class="title" style="display:none;">关系型数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/db-tutorial/03.关系型数据库/01.综合/" class="nav-link">综合</a></li><li class="dropdown-item"><!----> <a href="/db-tutorial/03.关系型数据库/02.Mysql/" class="nav-link">Mysql</a></li><li class="dropdown-item"><!----> <a href="/db-tutorial/03.关系型数据库/99.其他/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档数据库" class="dropdown-title"><!----> <span class="title" style="display:;">文档数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/db-tutorial/04.文档数据库/01.MongoDB/" class="nav-link">MongoDB</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="KV数据库" class="dropdown-title"><!----> <span class="title" style="display:;">KV数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/db-tutorial/05.KV数据库/01.Redis/" class="nav-link">Redis</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="搜索引擎数据库" class="dropdown-title"><!----> <span class="title" style="display:;">搜索引擎数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/db-tutorial/07.搜索引擎数据库/01.Elasticsearch/" class="nav-link">Elasticsearch</a></li><li class="dropdown-item"><!----> <a href="/db-tutorial/07.搜索引擎数据库/02.Elastic/" class="nav-link">Elastic技术栈</a></li></ul></div></div> <a href="https://github.com/dunwu/db-tutorial" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/db-tutorial/01.数据库综合/" class="nav-link">数据库综合</a></div><div class="nav-item"><a href="/db-tutorial/02.数据库中间件/" class="nav-link">数据库中间件</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关系型数据库" class="dropdown-title"><a href="/db-tutorial/03.关系型数据库/" class="link-title">关系型数据库</a> <span class="title" style="display:none;">关系型数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/db-tutorial/03.关系型数据库/01.综合/" class="nav-link">综合</a></li><li class="dropdown-item"><!----> <a href="/db-tutorial/03.关系型数据库/02.Mysql/" class="nav-link">Mysql</a></li><li class="dropdown-item"><!----> <a href="/db-tutorial/03.关系型数据库/99.其他/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档数据库" class="dropdown-title"><!----> <span class="title" style="display:;">文档数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/db-tutorial/04.文档数据库/01.MongoDB/" class="nav-link">MongoDB</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="KV数据库" class="dropdown-title"><!----> <span class="title" style="display:;">KV数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/db-tutorial/05.KV数据库/01.Redis/" class="nav-link">Redis</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="搜索引擎数据库" class="dropdown-title"><!----> <span class="title" style="display:;">搜索引擎数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/db-tutorial/07.搜索引擎数据库/01.Elasticsearch/" class="nav-link">Elasticsearch</a></li><li class="dropdown-item"><!----> <a href="/db-tutorial/07.搜索引擎数据库/02.Elastic/" class="nav-link">Elastic技术栈</a></li></ul></div></div> <a href="https://github.com/dunwu/db-tutorial" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Elasticsearch</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/db-tutorial/pages/aa9e4a/" class="sidebar-link">Elasticsearch 面试总结</a></li><li><a href="/db-tutorial/pages/868e6c/" class="sidebar-link">Elasticsearch 快速入门</a></li><li><a href="/db-tutorial/pages/ac661a/" class="sidebar-link">Elasticsearch 简介</a></li><li><a href="/db-tutorial/pages/db5f76/" class="sidebar-link">Elasticsearch 索引</a></li><li><a href="/db-tutorial/pages/a88250/" class="sidebar-link">Elasticsearch 查询</a></li><li><a href="/db-tutorial/pages/588753/" class="sidebar-link">Elasticsearch 高亮搜索及显示</a></li><li><a href="/db-tutorial/pages/91b465/" class="sidebar-link">Elasticsearch 排序</a></li><li><a href="/db-tutorial/pages/601224/" aria-current="page" class="active sidebar-link">Elasticsearch 聚合</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/db-tutorial/pages/601224/#_1-聚合的具体结构" class="sidebar-link">1. 聚合的具体结构</a></li><li class="sidebar-sub-header level2"><a href="/db-tutorial/pages/601224/#_2-指标聚合" class="sidebar-link">2. 指标聚合</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/db-tutorial/pages/601224/#_2-1-max-aggregation" class="sidebar-link">2.1. Max Aggregation</a></li><li class="sidebar-sub-header level3"><a href="/db-tutorial/pages/601224/#_2-2-min-aggregation" class="sidebar-link">2.2. Min Aggregation</a></li><li class="sidebar-sub-header level3"><a href="/db-tutorial/pages/601224/#_2-3-avg-aggregation" class="sidebar-link">2.3. Avg Aggregation</a></li><li class="sidebar-sub-header level3"><a href="/db-tutorial/pages/601224/#_2-4-sum-aggregation" class="sidebar-link">2.4. Sum Aggregation</a></li><li class="sidebar-sub-header level3"><a href="/db-tutorial/pages/601224/#_2-5-value-count-aggregation" class="sidebar-link">2.5. Value Count Aggregation</a></li><li class="sidebar-sub-header level3"><a href="/db-tutorial/pages/601224/#_2-6-cardinality-aggregation" class="sidebar-link">2.6. Cardinality Aggregation</a></li><li class="sidebar-sub-header level3"><a href="/db-tutorial/pages/601224/#_2-7-stats-aggregation" class="sidebar-link">2.7. Stats Aggregation</a></li><li class="sidebar-sub-header level3"><a href="/db-tutorial/pages/601224/#_2-8-extended-stats-aggregation" class="sidebar-link">2.8. Extended Stats Aggregation</a></li><li class="sidebar-sub-header level3"><a href="/db-tutorial/pages/601224/#_2-9-percentiles-aggregation" class="sidebar-link">2.9. Percentiles Aggregation</a></li><li class="sidebar-sub-header level3"><a href="/db-tutorial/pages/601224/#_2-10-percentiles-ranks-aggregation" class="sidebar-link">2.10. Percentiles Ranks Aggregation</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/db-tutorial/pages/601224/#_3-桶聚合" class="sidebar-link">3. 桶聚合</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/db-tutorial/pages/601224/#_3-1-terms-aggregation" class="sidebar-link">3.1. Terms Aggregation</a></li><li class="sidebar-sub-header level3"><a href="/db-tutorial/pages/601224/#_3-2-filter-aggregation" class="sidebar-link">3.2. Filter Aggregation</a></li><li class="sidebar-sub-header level3"><a href="/db-tutorial/pages/601224/#_3-3-filters-aggregation" class="sidebar-link">3.3. Filters Aggregation</a></li><li class="sidebar-sub-header level3"><a href="/db-tutorial/pages/601224/#_3-4-range-aggregation" class="sidebar-link">3.4. Range Aggregation</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/db-tutorial/pages/601224/#_4-参考资料" class="sidebar-link">4. 参考资料</a></li></ul></li><li><a href="/db-tutorial/pages/baef46/" class="sidebar-link">Elasticsearch 分析器</a></li><li><a href="/db-tutorial/pages/cf8acd/" class="sidebar-link">Elasticsearch 性能优化</a></li><li><a href="/db-tutorial/pages/18103a/" class="sidebar-link">Elasticsearch Rest API</a></li><li><a href="/db-tutorial/pages/90e1b8/" class="sidebar-link">ElasticSearch Java API 之 High Level REST Client</a></li><li><a href="/db-tutorial/pages/58cab4/" class="sidebar-link">Elasticsearch 集群和分片</a></li><li><a href="/db-tutorial/pages/bd9759/" class="sidebar-link">Elasticsearch 运维</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Elastic</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/db-tutorial/pages/e83871/" class="sidebar-link">Elastic 快速入门</a></li><li><a href="/db-tutorial/pages/6aed4b/" class="sidebar-link">Elastic 技术栈之 Filebeat</a></li><li><a href="/db-tutorial/pages/6b4129/" class="sidebar-link">Filebeat 运维</a></li><li><a href="/db-tutorial/pages/3ba500/" class="sidebar-link">Elastic 技术栈之 Kibana</a></li><li><a href="/db-tutorial/pages/42be7f/" class="sidebar-link">Kibana 运维</a></li><li><a href="/db-tutorial/pages/f07355/" class="sidebar-link">Elastic 技术栈之 Logstash</a></li><li><a href="/db-tutorial/pages/c5c564/" class="sidebar-link">Logstash 运维</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1baff76c><div class="articleInfo" data-v-1baff76c><ul class="breadcrumbs" data-v-1baff76c><li data-v-1baff76c><a href="/db-tutorial/" title="首页" class="iconfont icon-home router-link-active" data-v-1baff76c></a></li> <li data-v-1baff76c><span data-v-1baff76c>搜索引擎数据库</span></li><li data-v-1baff76c><span data-v-1baff76c>Elasticsearch</span></li></ul> <div class="info" data-v-1baff76c><div title="作者" class="author iconfont icon-touxiang" data-v-1baff76c><a href="https://github.com/dunwu" target="_blank" title="作者" class="beLink" data-v-1baff76c>dunwu</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1baff76c><a href="javascript:;" data-v-1baff76c>2022-01-19</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">Elasticsearch 聚合<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="elasticsearch-聚合"><a href="#elasticsearch-聚合" class="header-anchor">#</a> Elasticsearch 聚合</h1> <p>Elasticsearch 是一个分布式的全文搜索引擎，索引和搜索是 Elasticsearch 的基本功能。事实上，Elasticsearch 的聚合（Aggregations）功能也十分强大，允许在数据上做复杂的分析统计。Elasticsearch 提供的聚合分析功能主要有<strong>指标聚合(metrics aggregations)</strong>、<strong>桶聚合(bucket aggregations)</strong>、<strong>管道聚合(pipeline aggregations)</strong> 和 <strong>矩阵聚合(matrix aggregations)</strong> 四大类，管道聚合和矩阵聚合官方说明是在试验阶段，后期会完全更改或者移除，这里不再对管道聚合和矩阵聚合进行讲解。</p> <ul><li><a href="#1-%E8%81%9A%E5%90%88%E7%9A%84%E5%85%B7%E4%BD%93%E7%BB%93%E6%9E%84">1. 聚合的具体结构</a></li> <li><a href="#2-%E6%8C%87%E6%A0%87%E8%81%9A%E5%90%88">2. 指标聚合</a> <ul><li><a href="#21-max-aggregation">2.1. Max Aggregation</a></li> <li><a href="#22-min-aggregation">2.2. Min Aggregation</a></li> <li><a href="#23-avg-aggregation">2.3. Avg Aggregation</a></li> <li><a href="#24-sum-aggregation">2.4. Sum Aggregation</a></li> <li><a href="#25-value-count-aggregation">2.5. Value Count Aggregation</a></li> <li><a href="#26-cardinality-aggregation">2.6. Cardinality Aggregation</a></li> <li><a href="#27-stats-aggregation">2.7. Stats Aggregation</a></li> <li><a href="#28-extended-stats-aggregation">2.8. Extended Stats Aggregation</a></li> <li><a href="#29-percentiles-aggregation">2.9. Percentiles Aggregation</a></li> <li><a href="#210-percentiles-ranks-aggregation">2.10. Percentiles Ranks Aggregation</a></li></ul></li> <li><a href="#3-%E6%A1%B6%E8%81%9A%E5%90%88">3. 桶聚合</a> <ul><li><a href="#31-terms-aggregation">3.1. Terms Aggregation</a></li> <li><a href="#32-filter-aggregation">3.2. Filter Aggregation</a></li> <li><a href="#33-filters-aggregation">3.3. Filters Aggregation</a></li> <li><a href="#34-range-aggregation">3.4. Range Aggregation</a></li></ul></li> <li><a href="#4-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">4. 参考资料</a></li></ul> <h2 id="_1-聚合的具体结构"><a href="#_1-聚合的具体结构" class="header-anchor">#</a> 1. 聚合的具体结构</h2> <p>所有的聚合，无论它们是什么类型，都遵从以下的规则。</p> <ul><li>使用查询中同样的 JSON 请求来定义它们，而且你是使用键 aggregations 或者是 aggs 来进行标记。需要给每个聚合起一个名字，指定它的类型以及和该类型相关的选项。</li> <li>它们运行在查询的结果之上。和查询不匹配的文档不会计算在内，除非你使用 global 聚集将不匹配的文档囊括其中。</li> <li>可以进一步过滤查询的结果，而不影响聚集。</li></ul> <p>以下是聚合的基本结构：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;aggregations&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> &lt;!-- 最外层的聚合键，也可以缩写为 aggs --&gt;
    <span class="token property">&quot;&lt;aggregation_name&gt;&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> &lt;!-- 聚合的自定义名字 --&gt;
        <span class="token property">&quot;&lt;aggregation_type&gt;&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> &lt;!-- 聚合的类型，指标相关的，如 max、min、avg、sum，桶相关的 terms、filter 等 --&gt;
            &lt;aggregation_body&gt; &lt;!-- 聚合体：对哪些字段进行聚合，可以取字段的值，也可以是脚本计算的结果 --&gt;
        <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token property">&quot;meta&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token punctuation">[</span>&lt;meta_data_body&gt;<span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>? &lt;!-- 元 --&gt;
        <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token property">&quot;aggregations&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>&lt;sub_aggregation&gt;<span class="token punctuation">]</span>+ <span class="token punctuation">}</span> <span class="token punctuation">]</span>? &lt;!-- 在聚合里面在定义子聚合 --&gt;
    <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token property">&quot;&lt;aggregation_name_2&gt;&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span> ... <span class="token punctuation">}</span> <span class="token punctuation">]</span>* &lt;!-- 聚合的自定义名字 <span class="token number">2</span> --&gt;
<span class="token punctuation">}</span>
</code></pre></div><ul><li><strong>在最上层有一个 aggregations 的键，可以缩写为 aggs</strong>。</li> <li>在下面一层，需要为聚合指定一个名字。可以在请求的返回中看到这个名字。在同一个请求中使用多个聚合时，这一点非常有用，它让你可以很容易地理解每组结果的含义。</li> <li>最后，必须要指定聚合的类型。</li></ul> <blockquote><p>关于聚合分析的值来源，可以<strong>取字段的值</strong>，也可以是<strong>脚本计算的结果</strong>。</p> <p>但是用脚本计算的结果时，需要注意脚本的性能和安全性；尽管多数聚集类型允许使用脚本，但是脚本使得聚集变得缓慢，因为脚本必须在每篇文档上运行。为了避免脚本的运行，可以在索引阶段进行计算。</p> <p>此外，脚本也可以被人可能利用进行恶意代码攻击，尽量使用沙盒（sandbox）内的脚本语言。</p></blockquote> <p>示例：查询所有球员的平均年龄是多少，并对球员的平均薪水加 188（也可以理解为每名球员加 188 后的平均薪水）。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>POST /player/_search?size<span class="token operator">=</span><span class="token number">0</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;aggs&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;avg_age&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;avg&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;field&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;age&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;avg_salary_188&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;avg&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;script&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;source&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;doc.salary.value + 188&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_2-指标聚合"><a href="#_2-指标聚合" class="header-anchor">#</a> 2. 指标聚合</h2> <p>指标聚合（又称度量聚合）主要从不同文档的分组中提取统计数据，或者，从来自其他聚合的文档桶来提取统计数据。</p> <p>这些统计数据通常来自数值型字段，如最小或者平均价格。用户可以单独获取每项统计数据，或者也可以使用 stats 聚合来同时获取它们。更高级的统计数据，如平方和或者是标准差，可以通过 extended stats 聚合来获取。</p> <h3 id="_2-1-max-aggregation"><a href="#_2-1-max-aggregation" class="header-anchor">#</a> 2.1. Max Aggregation</h3> <p>Max Aggregation 用于最大值统计。例如，统计 sales 索引中价格最高的是哪本书，并且计算出对应的价格的 2 倍值，查询语句如下：</p> <div class="language- extra-class"><pre class="language-text"><code>GET /sales/_search?size=0
{
  &quot;aggs&quot; : {
    &quot;max_price&quot; : {
      &quot;max&quot; : {
        &quot;field&quot; : &quot;price&quot;
      }
    },
    &quot;max_price_2&quot; : {
      &quot;max&quot; : {
        &quot;field&quot; : &quot;price&quot;,
        &quot;script&quot;: {
          &quot;source&quot;: &quot;_value * 2.0&quot;
        }
      }
    }
  }
}
</code></pre></div><p><strong>指定的 field，在脚本中可以用 _value 取字段的值</strong>。</p> <p>聚合结果如下：</p> <div class="language- extra-class"><pre class="language-text"><code>{
  ...
  &quot;aggregations&quot;: {
    &quot;max_price&quot;: {
      &quot;value&quot;: 188.0
    },
    &quot;max_price_2&quot;: {
      &quot;value&quot;: 376.0
    }
  }
}
</code></pre></div><h3 id="_2-2-min-aggregation"><a href="#_2-2-min-aggregation" class="header-anchor">#</a> 2.2. Min Aggregation</h3> <p>Min Aggregation 用于最小值统计。例如，统计 sales 索引中价格最低的是哪本书，查询语句如下：</p> <div class="language- extra-class"><pre class="language-text"><code>GET /sales/_search?size=0
{
  &quot;aggs&quot; : {
    &quot;min_price&quot; : {
      &quot;min&quot; : {
        &quot;field&quot; : &quot;price&quot;
      }
    }
  }
}
</code></pre></div><p>聚合结果如下：</p> <div class="language- extra-class"><pre class="language-text"><code>{
  ...
  &quot;aggregations&quot;: {
    &quot;min_price&quot;: {
      &quot;value&quot;: 18.0
    }
  }
}
</code></pre></div><h3 id="_2-3-avg-aggregation"><a href="#_2-3-avg-aggregation" class="header-anchor">#</a> 2.3. Avg Aggregation</h3> <p>Avg Aggregation 用于计算平均值。例如，统计 exams 索引中考试的平均分数，如未存在分数，默认为 60 分，查询语句如下：</p> <div class="language- extra-class"><pre class="language-text"><code>GET /exams/_search?size=0
{
  &quot;aggs&quot; : {
    &quot;avg_grade&quot; : {
      &quot;avg&quot; : {
        &quot;field&quot; : &quot;grade&quot;,
        &quot;missing&quot;: 60
      }
    }
  }
}
</code></pre></div><p><strong>如果指定字段没有值，可以通过 missing 指定默认值；若未指定默认值，缺失该字段值的文档将被忽略（计算）</strong>。</p> <p>聚合结果如下：</p> <div class="language- extra-class"><pre class="language-text"><code>{
  ...
  &quot;aggregations&quot;: {
    &quot;avg_grade&quot;: {
      &quot;value&quot;: 78.0
    }
  }
}
</code></pre></div><p>除了常规的平均值聚合计算外，elasticsearch 还提供了加权平均值的聚合计算，详情参见 <a href="https://www.knowledgedict.com/tutorial/elasticsearch-aggregations-metrics-weighted-avg-aggregation.html" target="_blank" rel="noopener noreferrer">Elasticsearch 指标聚合之 Weighted Avg Aggregation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h3 id="_2-4-sum-aggregation"><a href="#_2-4-sum-aggregation" class="header-anchor">#</a> 2.4. Sum Aggregation</h3> <p>Sum Aggregation 用于计算总和。例如，统计 sales 索引中 type 字段中匹配 hat 的价格总和，查询语句如下：</p> <div class="language- extra-class"><pre class="language-text"><code>GET /exams/_search?size=0
{
  &quot;query&quot; : {
    &quot;constant_score&quot; : {
      &quot;filter&quot; : {
        &quot;match&quot; : { &quot;type&quot; : &quot;hat&quot; }
      }
    }
  },
  &quot;aggs&quot; : {
    &quot;hat_prices&quot; : {
      &quot;sum&quot; : { &quot;field&quot; : &quot;price&quot; }
    }
  }
}
</code></pre></div><p>聚合结果如下：</p> <div class="language- extra-class"><pre class="language-text"><code>{
  ...
  &quot;aggregations&quot;: {
    &quot;hat_prices&quot;: {
      &quot;value&quot;: 567.0
    }
  }
}
</code></pre></div><h3 id="_2-5-value-count-aggregation"><a href="#_2-5-value-count-aggregation" class="header-anchor">#</a> 2.5. Value Count Aggregation</h3> <p>Value Count Aggregation 可按字段统计文档数量。例如，统计 books 索引中包含 author 字段的文档数量，查询语句如下：</p> <div class="language- extra-class"><pre class="language-text"><code>GET /books/_search?size=0
{
  &quot;aggs&quot; : {
    &quot;doc_count&quot; : {
      &quot;value_count&quot; : { &quot;field&quot; : &quot;author&quot; }
    }
  }
}
</code></pre></div><p>聚合结果如下：</p> <div class="language- extra-class"><pre class="language-text"><code>{
  ...
  &quot;aggregations&quot;: {
    &quot;doc_count&quot;: {
      &quot;value&quot;: 5
    }
  }
}
</code></pre></div><h3 id="_2-6-cardinality-aggregation"><a href="#_2-6-cardinality-aggregation" class="header-anchor">#</a> 2.6. Cardinality Aggregation</h3> <p>Cardinality Aggregation 用于基数统计，其作用是先执行类似 SQL 中的 distinct 操作，去掉集合中的重复项，然后统计去重后的集合长度。例如，在 books 索引中对 language 字段进行 cardinality 操作可以统计出编程语言的种类数，查询语句如下：</p> <div class="language- extra-class"><pre class="language-text"><code>GET /books/_search?size=0
{
  &quot;aggs&quot; : {
    &quot;all_lan&quot; : {
      &quot;cardinality&quot; : { &quot;field&quot; : &quot;language&quot; }
    },
    &quot;title_cnt&quot; : {
      &quot;cardinality&quot; : { &quot;field&quot; : &quot;title.keyword&quot; }
    }
  }
}
</code></pre></div><p><strong>假设 title 字段为文本类型（text），去重时需要指定 keyword，表示把 title 作为整体去重，即不分词统计</strong>。</p> <p>聚合结果如下：</p> <div class="language- extra-class"><pre class="language-text"><code>{
  ...
  &quot;aggregations&quot;: {
    &quot;all_lan&quot;: {
      &quot;value&quot;: 8
    },
    &quot;title_cnt&quot;: {
      &quot;value&quot;: 18
    }
  }
}
</code></pre></div><h3 id="_2-7-stats-aggregation"><a href="#_2-7-stats-aggregation" class="header-anchor">#</a> 2.7. Stats Aggregation</h3> <p>Stats Aggregation 用于基本统计，会一次返回 count、max、min、avg 和 sum 这 5 个指标。例如，在 exams 索引中对 grade 字段进行分数相关的基本统计，查询语句如下：</p> <div class="language- extra-class"><pre class="language-text"><code>GET /exams/_search?size=0
{
  &quot;aggs&quot; : {
    &quot;grades_stats&quot; : {
      &quot;stats&quot; : { &quot;field&quot; : &quot;grade&quot; }
    }
  }
}
</code></pre></div><p>聚合结果如下：</p> <div class="language- extra-class"><pre class="language-text"><code>{
  ...
  &quot;aggregations&quot;: {
    &quot;grades_stats&quot;: {
      &quot;count&quot;: 2,
      &quot;min&quot;: 50.0,
      &quot;max&quot;: 100.0,
      &quot;avg&quot;: 75.0,
      &quot;sum&quot;: 150.0
    }
  }
}
</code></pre></div><h3 id="_2-8-extended-stats-aggregation"><a href="#_2-8-extended-stats-aggregation" class="header-anchor">#</a> 2.8. Extended Stats Aggregation</h3> <p>Extended Stats Aggregation 用于高级统计，和基本统计功能类似，但是会比基本统计多出以下几个统计结果，sum_of_squares（平方和）、variance（方差）、std_deviation（标准差）、std_deviation_bounds（平均值加/减两个标准差的区间）。在 exams 索引中对 grade 字段进行分数相关的高级统计，查询语句如下：</p> <div class="language- extra-class"><pre class="language-text"><code>GET /exams/_search?size=0
{
  &quot;aggs&quot; : {
    &quot;grades_stats&quot; : {
      &quot;extended_stats&quot; : { &quot;field&quot; : &quot;grade&quot; }
    }
  }
}
</code></pre></div><p>聚合结果如下：</p> <div class="language- extra-class"><pre class="language-text"><code>{
  ...
  &quot;aggregations&quot;: {
    &quot;grades_stats&quot;: {
      &quot;count&quot;: 2,
      &quot;min&quot;: 50.0,
      &quot;max&quot;: 100.0,
      &quot;avg&quot;: 75.0,
      &quot;sum&quot;: 150.0,
      &quot;sum_of_squares&quot;: 12500.0,
      &quot;variance&quot;: 625.0,
      &quot;std_deviation&quot;: 25.0,
      &quot;std_deviation_bounds&quot;: {
        &quot;upper&quot;: 125.0,
        &quot;lower&quot;: 25.0
      }
    }
  }
}
</code></pre></div><h3 id="_2-9-percentiles-aggregation"><a href="#_2-9-percentiles-aggregation" class="header-anchor">#</a> 2.9. Percentiles Aggregation</h3> <p>Percentiles Aggregation 用于百分位统计。百分位数是一个统计学术语，如果将一组数据从大到小排序，并计算相应的累计百分位，某一百分位所对应数据的值就称为这一百分位的百分位数。默认情况下，累计百分位为 [ 1, 5, 25, 50, 75, 95, 99 ]。以下例子给出了在 latency 索引中对 load_time 字段进行加载时间的百分位统计，查询语句如下：</p> <div class="language- extra-class"><pre class="language-text"><code>GET latency/_search
{
  &quot;size&quot;: 0,
  &quot;aggs&quot; : {
    &quot;load_time_outlier&quot; : {
      &quot;percentiles&quot; : {
        &quot;field&quot; : &quot;load_time&quot;
      }
    }
  }
}
</code></pre></div><p><strong>需要注意的是，如上的 <code>load_time</code> 字段必须是数字类型</strong>。</p> <p>聚合结果如下：</p> <div class="language- extra-class"><pre class="language-text"><code>{
  ...
  &quot;aggregations&quot;: {
    &quot;load_time_outlier&quot;: {
      &quot;values&quot; : {
        &quot;1.0&quot;: 5.0,
        &quot;5.0&quot;: 25.0,
        &quot;25.0&quot;: 165.0,
        &quot;50.0&quot;: 445.0,
        &quot;75.0&quot;: 725.0,
        &quot;95.0&quot;: 945.0,
        &quot;99.0&quot;: 985.0
      }
    }
  }
}
</code></pre></div><p>百分位的统计也可以指定 percents 参数指定百分位，如下：</p> <div class="language- extra-class"><pre class="language-text"><code>GET latency/_search
{
  &quot;size&quot;: 0,
  &quot;aggs&quot; : {
    &quot;load_time_outlier&quot; : {
      &quot;percentiles&quot; : {
        &quot;field&quot; : &quot;load_time&quot;,
        &quot;percents&quot;: [60, 80, 95]
      }
    }
  }
}
</code></pre></div><h3 id="_2-10-percentiles-ranks-aggregation"><a href="#_2-10-percentiles-ranks-aggregation" class="header-anchor">#</a> 2.10. Percentiles Ranks Aggregation</h3> <p>Percentiles Ranks Aggregation 与 Percentiles Aggregation 统计恰恰相反，就是想看当前数值处在什么范围内（百分位）， 假如你查一下当前值 500 和 600 所处的百分位，发现是 90.01 和 100，那么说明有 90.01 % 的数值都在 500 以内，100 % 的数值在 600 以内。</p> <div class="language- extra-class"><pre class="language-text"><code>GET latency/_search
{
  &quot;size&quot;: 0,
    &quot;aggs&quot; : {
      &quot;load_time_ranks&quot; : {
        &quot;percentile_ranks&quot; : {
          &quot;field&quot; : &quot;load_time&quot;,
          &quot;values&quot; : [500, 600]
        }
      }
  }
}
</code></pre></div><p><strong><code>同样 load_time</code> 字段必须是数字类型</strong>。</p> <p>返回结果大概类似如下：</p> <div class="language- extra-class"><pre class="language-text"><code>{
  ...
  &quot;aggregations&quot;: {
    &quot;load_time_ranks&quot;: {
      &quot;values&quot; : {
        &quot;500.0&quot;: 90.01,
        &quot;600.0&quot;: 100.0
      }
    }
  }
}
</code></pre></div><p>可以设置 <code>keyed</code> 参数为 <code>true</code>，将对应的 values 作为桶 key 一起返回，默认是 <code>false</code>。</p> <div class="language- extra-class"><pre class="language-text"><code>GET latency/_search
{
  &quot;size&quot;: 0,
  &quot;aggs&quot;: {
    &quot;load_time_ranks&quot;: {
      &quot;percentile_ranks&quot;: {
        &quot;field&quot;: &quot;load_time&quot;,
        &quot;values&quot;: [500, 600],
        &quot;keyed&quot;: true
      }
    }
  }
}
</code></pre></div><p>返回结果如下：</p> <div class="language- extra-class"><pre class="language-text"><code>{
  ...
  &quot;aggregations&quot;: {
    &quot;load_time_ranks&quot;: {
      &quot;values&quot;: [
        {
          &quot;key&quot;: 500.0,
          &quot;value&quot;: 90.01
        },
        {
          &quot;key&quot;: 600.0,
          &quot;value&quot;: 100.0
        }
      ]
    }
  }
}
</code></pre></div><h2 id="_3-桶聚合"><a href="#_3-桶聚合" class="header-anchor">#</a> 3. 桶聚合</h2> <p>bucket 可以理解为一个桶，它会遍历文档中的内容，凡是符合某一要求的就放入一个桶中，分桶相当于 SQL 中的 group by。从另外一个角度，可以将指标聚合看成单桶聚合，即把所有文档放到一个桶中，而桶聚合是多桶型聚合，它根据相应的条件进行分组。</p> <table><thead><tr><th style="text-align:left;">种类</th> <th style="text-align:left;">描述/场景</th></tr></thead> <tbody><tr><td style="text-align:left;">词项聚合（Terms Aggregation）</td> <td style="text-align:left;">用于分组聚合，让用户得知文档中每个词项的频率，它返回每个词项出现的次数。</td></tr> <tr><td style="text-align:left;">差异词项聚合（Significant Terms Aggregation）</td> <td style="text-align:left;">它会返回某个词项在整个索引中和在查询结果中的词频差异，这有助于我们发现搜索场景中有意义的词。</td></tr> <tr><td style="text-align:left;">过滤器聚合（Filter Aggregation）</td> <td style="text-align:left;">指定过滤器匹配的所有文档到单个桶（bucket），通常这将用于将当前聚合上下文缩小到一组特定的文档。</td></tr> <tr><td style="text-align:left;">多过滤器聚合（Filters Aggregation）</td> <td style="text-align:left;">指定多个过滤器匹配所有文档到多个桶（bucket）。</td></tr> <tr><td style="text-align:left;">范围聚合（Range Aggregation）</td> <td style="text-align:left;">范围聚合，用于反映数据的分布情况。</td></tr> <tr><td style="text-align:left;">日期范围聚合（Date Range Aggregation）</td> <td style="text-align:left;">专门用于日期类型的范围聚合。</td></tr> <tr><td style="text-align:left;">IP 范围聚合（IP Range Aggregation）</td> <td style="text-align:left;">用于对 IP 类型数据范围聚合。</td></tr> <tr><td style="text-align:left;">直方图聚合（Histogram Aggregation）</td> <td style="text-align:left;">可能是数值，或者日期型，和范围聚集类似。</td></tr> <tr><td style="text-align:left;">时间直方图聚合（Date Histogram Aggregation）</td> <td style="text-align:left;">时间直方图聚合，常用于按照日期对文档进行统计并绘制条形图。</td></tr> <tr><td style="text-align:left;">空值聚合（Missing Aggregation）</td> <td style="text-align:left;">空值聚合，可以把文档集中所有缺失字段的文档分到一个桶中。</td></tr> <tr><td style="text-align:left;">地理点范围聚合（Geo Distance Aggregation）</td> <td style="text-align:left;">用于对地理点（geo point）做范围统计。</td></tr></tbody></table> <h3 id="_3-1-terms-aggregation"><a href="#_3-1-terms-aggregation" class="header-anchor">#</a> 3.1. Terms Aggregation</h3> <p>Terms Aggregation 用于词项的分组聚合。最为经典的用例是获取 X 中最频繁（top frequent）的项目，其中 X 是文档中的某个字段，如用户的名称、标签或分类。由于 terms 聚集统计的是每个词条，而不是整个字段值，因此通常需要在一个非分析型的字段上运行这种聚集。原因是, 你期望“big data”作为词组统计，而不是“big”单独统计一次，“data”再单独统计一次。</p> <p>用户可以使用 terms 聚集，从分析型字段（如内容）中抽取最为频繁的词条。还可以使用这种信息来生成一个单词云。</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;aggs&quot;: {
    &quot;profit_terms&quot;: {
      &quot;terms&quot;: { // terms 聚合 关键字
        &quot;field&quot;: &quot;profit&quot;,
        ......
      }
    }
  }
}
</code></pre></div><p>在 terms 分桶的基础上，还可以对每个桶进行指标统计，也可以基于一些指标或字段值进行排序。示例如下：</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;aggs&quot;: {
    &quot;item_terms&quot;: {
      &quot;terms&quot;: {
        &quot;field&quot;: &quot;item_id&quot;,
        &quot;size&quot;: 1000,
        &quot;order&quot;:[{
          &quot;gmv_stat&quot;: &quot;desc&quot;
        },{
          &quot;gmv_180d&quot;: &quot;desc&quot;
        }]
      },
      &quot;aggs&quot;: {
        &quot;gmv_stat&quot;: {
          &quot;sum&quot;: {
            &quot;field&quot;: &quot;gmv&quot;
          }
        },
        &quot;gmv_180d&quot;: {
          &quot;sum&quot;: {
            &quot;script&quot;: &quot;doc['gmv_90d'].value*2&quot;
          }
        }
      }
    }
  }
}
</code></pre></div><p>返回的结果如下：</p> <div class="language- extra-class"><pre class="language-text"><code>{
  ...
  &quot;aggregations&quot;: {
    &quot;hospital_id_agg&quot;: {
      &quot;doc_count_error_upper_bound&quot;: 0,
      &quot;sum_other_doc_count&quot;: 260,
      &quot;buckets&quot;: [
        {
          &quot;key&quot;: 23388,
          &quot;doc_count&quot;: 18,
          &quot;gmv_stat&quot;: {
            &quot;value&quot;: 176220
          },
          &quot;gmv_180d&quot;: {
            &quot;value&quot;: 89732
          }
        },
        {
          &quot;key&quot;: 96117,
          &quot;doc_count&quot;: 16,
          &quot;gmv_stat&quot;: {
            &quot;value&quot;: 129306
          },
          &quot;gmv_180d&quot;: {
            &quot;value&quot;: 56988
          }
        },
        ...
      ]
    }
  }
}
</code></pre></div><p>默认情况下返回按文档计数从高到低的前 10 个分组，可以通过 size 参数指定返回的分组数。</p> <h3 id="_3-2-filter-aggregation"><a href="#_3-2-filter-aggregation" class="header-anchor">#</a> 3.2. Filter Aggregation</h3> <p>Filter Aggregation 是过滤器聚合，可以把符合过滤器中的条件的文档分到一个桶中，即是单分组聚合。</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;aggs&quot;: {
    &quot;age_terms&quot;: {
      &quot;filter&quot;: {&quot;match&quot;:{&quot;gender&quot;:&quot;F&quot;}},
      &quot;aggs&quot;: {
        &quot;avg_age&quot;: {
          &quot;avg&quot;: {
            &quot;field&quot;: &quot;age&quot;
          }
        }
      }
    }
  }
}
</code></pre></div><h3 id="_3-3-filters-aggregation"><a href="#_3-3-filters-aggregation" class="header-anchor">#</a> 3.3. Filters Aggregation</h3> <p>Filters Aggregation 是多过滤器聚合，可以把符合多个过滤条件的文档分到不同的桶中，即每个分组关联一个过滤条件，并收集所有满足自身过滤条件的文档。</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;size&quot;: 0,
  &quot;aggs&quot;: {
    &quot;messages&quot;: {
      &quot;filters&quot;: {
        &quot;filters&quot;: {
          &quot;errors&quot;: { &quot;match&quot;: { &quot;body&quot;: &quot;error&quot; } },
          &quot;warnings&quot;: { &quot;match&quot;: { &quot;body&quot;: &quot;warning&quot; } }
        }
      }
    }
  }
}
</code></pre></div><p>在这个例子里，我们分析日志信息。聚合会创建两个关于日志数据的分组，一个收集包含错误信息的文档，另一个收集包含告警信息的文档。而且每个分组会按月份划分。</p> <div class="language- extra-class"><pre class="language-text"><code>{
  ...
  &quot;aggregations&quot;: {
    &quot;messages&quot;: {
      &quot;buckets&quot;: {
        &quot;errors&quot;: {
          &quot;doc_count&quot;: 1
        },
        &quot;warnings&quot;: {
          &quot;doc_count&quot;: 2
        }
      }
    }
  }
}
</code></pre></div><h3 id="_3-4-range-aggregation"><a href="#_3-4-range-aggregation" class="header-anchor">#</a> 3.4. Range Aggregation</h3> <p>Range Aggregation 范围聚合是一个基于多组值来源的聚合，可以让用户定义一系列范围，每个范围代表一个分组。在聚合执行的过程中，从每个文档提取出来的值都会检查每个分组的范围，并且使相关的文档落入分组中。注意，范围聚合的每个范围内包含 from 值但是排除 to 值。</p> <div class="language- extra-class"><pre class="language-text"><code>{
  &quot;aggs&quot;: {
    &quot;age_range&quot;: {
      &quot;range&quot;: {
        &quot;field&quot;: &quot;age&quot;,
          &quot;ranges&quot;: [{
            &quot;to&quot;: 25
          },
          {
            &quot;from&quot;: 25,
            &quot;to&quot;: 35
          },
          {
            &quot;from&quot;: 35
          }]
        },
        &quot;aggs&quot;: {
          &quot;bmax&quot;: {
            &quot;max&quot;: {
              &quot;field&quot;: &quot;balance&quot;
            }
          }
        }
      }
    }
  }
}
</code></pre></div><p>返回结果如下：</p> <div class="language- extra-class"><pre class="language-text"><code>{
  ...
  &quot;aggregations&quot;: {
    &quot;age_range&quot;: {
      &quot;buckets&quot;: [{
        &quot;key&quot;: &quot;*-25.0&quot;,
        &quot;to&quot;: 25,
        &quot;doc_count&quot;: 225,
        &quot;bmax&quot;: {
          &quot;value&quot;: 49587
        }
      },
      {
        &quot;key&quot;: &quot;25.0-35.0&quot;,
        &quot;from&quot;: 25,
        &quot;to&quot;: 35,
        &quot;doc_count&quot;: 485,
        &quot;bmax&quot;: {
          &quot;value&quot;: 49795
        }
      },
      {
        &quot;key&quot;: &quot;35.0-*&quot;,
        &quot;from&quot;: 35,
        &quot;doc_count&quot;: 290,
        &quot;bmax&quot;: {
          &quot;value&quot;: 49989
        }
      }]
    }
  }
}
</code></pre></div><h2 id="_4-参考资料"><a href="#_4-参考资料" class="header-anchor">#</a> 4. 参考资料</h2> <ul><li><a href="https://www.knowledgedict.com/tutorial/elasticsearch-intro.html" target="_blank" rel="noopener noreferrer">Elasticsearch 教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <div class="page-slot page-slot-bottom">
  <div class="wwads-cn wwads-horizontal pageB" data-id="136" style="width:100%;max-height:80px;min-height:auto;"></div>
  <style>
    .pageB img{width:80px!important;}
    .wwads-horizontal .wwads-text, .wwads-content .wwads-text{line-height:1;}
  </style>
  </div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/dunwu/db-tutorial/edit/master/docs/07.搜索引擎数据库/01.Elasticsearch/08.Elasticsearch聚合.md" target="_blank" rel="noopener noreferrer">📝 帮助改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/db-tutorial/tags/?tag=%E6%95%B0%E6%8D%AE%E5%BA%93" title="标签">#数据库</a><a href="/db-tutorial/tags/?tag=%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E6%95%B0%E6%8D%AE%E5%BA%93" title="标签">#搜索引擎数据库</a><a href="/db-tutorial/tags/?tag=Elasticsearch" title="标签">#Elasticsearch</a><a href="/db-tutorial/tags/?tag=%E8%81%9A%E5%90%88" title="标签">#聚合</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/04/12, 16:16:10</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/db-tutorial/pages/91b465/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Elasticsearch 排序</div></a> <a href="/db-tutorial/pages/baef46/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Elasticsearch 分析器</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/db-tutorial/pages/91b465/" class="prev">Elasticsearch 排序</a></span> <span class="next"><a href="/db-tutorial/pages/baef46/">Elasticsearch 分析器</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/db-tutorial/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/db-tutorial/pages/84f411/"><div>
            数据库综合
            <!----></div></a> <span class="date">04-11</span></dt></dl><dl><dd>02</dd> <dt><a href="/db-tutorial/pages/057a1d/"><div>
            数据库中间件
            <!----></div></a> <span class="date">04-11</span></dt></dl><dl><dd>03</dd> <dt><a href="/db-tutorial/pages/d64774/"><div>
            关系型数据库其他知识
            <!----></div></a> <span class="date">04-11</span></dt></dl> <dl><dd></dd> <dt><a href="/db-tutorial/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:forbreak@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/dunwu" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2022
    <span>钝悟（dunwu） | CC-BY-SA-4.0</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><span class="close-but">×</span> <div>
    <div class="wwads-cn wwads-vertical windowRB" data-id="136" style="max-width:160px;
    min-width: auto;min-height:auto;"></div>
    <style>
      .windowRB{ padding: 0;}
      .windowRB .wwads-img{margin-top: 10px;}
      .windowRB .wwads-content{margin: 0 10px 10px 10px;}
      .custom-html-window-rb .close-but{
        display: none;
      }
    </style>
  </div></div></div></div><div class="global-ui"></div></div>
    <script src="/db-tutorial/assets/js/app.8ee26433.js" defer></script><script src="/db-tutorial/assets/js/2.f928080b.js" defer></script><script src="/db-tutorial/assets/js/61.ccb61a01.js" defer></script>
  </body>
</html>
